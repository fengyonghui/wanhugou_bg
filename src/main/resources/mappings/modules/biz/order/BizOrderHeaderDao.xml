<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wanhutong.backend.modules.biz.dao.order.BizOrderHeaderDao">
    
	<sql id="bizOrderHeaderColumns">
		a.id AS "id",
		a.order_num AS "orderNum",
		a.order_type AS "orderType",
		a.cust_id AS "customer.id",
		so.name as "customer.name",
		c.province_id as "bizLocation.province.id",
		province.name as "bizLocation.province.name",
		c.city_id as "bizLocation.city.id",
		city.name as "bizLocation.city.name",
		c.region_id as "bizLocation.region.id",
		reg.name as "bizLocation.region.name",
		c.address as "bizLocation.address",
		a.total_detail AS "totalDetail",
		a.receive_total as "receiveTotal",
		a.total_exp AS "totalExp",
		a.freight AS "freight",
		a.inv_status AS "invStatus",
		a.biz_status AS "bizStatus",
		a.biz_type as "bizType",
		a.plateform_id AS "platformInfo.id",
		bpi.name as "platformInfo.name",
		a.ship_to_addr AS "bizLocation.id",
		a.status AS "delFlag",
		a.create_id AS "createBy.id",
		su.name as "createBy.name",
		a.create_time AS "createDate",
		date_add(a.create_time, interval 7 day) as "deliveryDate",
		a.u_version AS "uVersion",
		a.update_id AS "updateBy.id",
		su.name as "updateBy.name",
		a.update_time AS "updateDate"
	</sql>
	
	<sql id="bizOrderHeaderJoins">
		left join sys_office as so on a.cust_id=so.id
		LEFT JOIN common_location c ON c.id = a.ship_to_addr
        LEFT JOIN sys_region province ON c.province_id = province.id
        LEFT JOIN sys_region city ON c.city_id = city.id
        LEFT JOIN sys_region reg ON c.region_id = reg.id
		left join sys_user su on a.create_id=su.id
		left join biz_cms_platform_info bpi on a.plateform_id=bpi.id
    	LEFT JOIN biz_custom_center_consultant ccs ON ccs.cust_id=a.cust_id
		LEFT JOIN sys_office s on s.id=ccs.center_id
	</sql>
    
	<select id="get" resultType="BizOrderHeader">
		SELECT 
			<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="BizOrderHeader">
		SELECT 
			<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		<where>
			a.status = #{DEL_FLAG_NORMAL}
			<if test="orderNum != null and orderNum != ''">
				AND a.order_num = #{orderNum}
			</if>
			<if test="orderType != null and orderType != ''">
				AND a.order_type = #{orderType}
			</if>
			<if test="customer != null and customer.id != null and customer.id!=''">
				AND a.cust_id = #{customer.id}
			</if>
			<if test="receiveTotal != null and receiveTotal != ''">
				AND a.receive_total = #{receiveTotal}
			</if>
			<if test="bizStatus !=null and bizStatus!=''">
				AND a.biz_status=#{bizStatus}
			</if>
			<if test="bizType !=null and bizType!=''">
				AND a.biz_type=#{bizType}
			</if>
			<if test="bizStatusStart !=null and bizStatusEnd !=null">
				AND a.biz_status BETWEEN #{bizStatusStart} and #{bizStatusEnd}
			</if>
			<if test="invStatus !=null and invStatus!=''">
				AND a.inv_status=#{invStatus}
			</if>
			<if test="sqlMap != null and sqlMap.order != null and sqlMap.order != ''">
				${sqlMap.order}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="BizOrderHeader">
		SELECT 
			<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		<where>
			a.status = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO biz_order_header(
			id,
			order_num,
			order_type,
			cust_id,
			total_detail,
			receive_total,
			total_exp,
			freight,
			inv_status,
			biz_status,
			biz_type,
			plateform_id,
			ship_to_addr,
			status,
			create_id,
			create_time,
			u_version,
			update_id,
			update_time
		) VALUES (
			#{id},
			#{orderNum},
			#{orderType},
			#{customer.id},
			#{totalDetail},
			#{receiveTotal},
			#{totalExp},
			#{freight},
			#{invStatus},
			#{bizStatus},
			#{bizType},
			#{platformInfo.id},
			#{bizLocation.id},
			#{delFlag},
			#{createBy.id},
			#{createDate},
			#{uVersion},
			#{updateBy.id},
			#{updateDate}
		)
	</insert>
	
	<update id="update">
		UPDATE biz_order_header SET 	
			order_num = #{orderNum},
			order_type = #{orderType},
			cust_id = #{customer.id},
			total_detail = #{totalDetail},
			receive_total = #{receiveTotal},
			total_exp = #{totalExp},
			freight = #{freight},
			inv_status = #{invStatus},
			biz_status = #{bizStatus},
			biz_type = #{bizType},
			plateform_id = #{platformInfo.id},
			ship_to_addr = #{bizLocation.id},
			u_version = #{uVersion},
			update_id = #{updateBy.id},
			update_time = #{updateDate}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE biz_order_header SET 
			status = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="findListFirstOrder" resultType="BizOrderHeader">
		SELECT
		<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		<where>
			a.status = #{DEL_FLAG_NORMAL}
			<if test="customer !=null and customer.id!=null and customer.id!=''">
				AND a.cust_id=#{customer.id}
			</if>
			<if test="bizStatus !=null">
				AND a.biz_status !=#{bizStatus}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
</mapper>