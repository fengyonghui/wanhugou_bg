<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wanhutong.backend.modules.biz.dao.order.BizOrderHeaderDao">

    <resultMap id="orderHeaderResult" type="BizOrderHeader">
        <id property="id" column="id"/>
        <result property="orderNum" column="orderNum"/>
        <result property="orderType" column="orderType"/>
        <result property="totalDetail" column="totalDetail"/>
        <result property="receiveTotal" column="receiveTotal"/>
        <result property="totalExp" column="totalExp"/>

        <result property="freight" column="freight"/>
        <result property="invStatus" column="invStatus"/>
        <result property="bizStatus" column="bizStatus"/>
        <result property="bizType" column="bizType"/>
        <result property="itemNo" column="itemNo"/>
        <result property="delFlag" column="status"/>

        <result property="createDate" column="createDate"/>
        <result property="updateDate" column="updateDate"/>

        <association property="customer" javaType="Office" column="customer.id">
            <id property="id" column="customer.id"/>
            <result property="name" column="customer.name"/>
            <result property="phone" column="customer.phone"/>
        </association>

        <association property="bizLocation" javaType="BizOrderAddress" column="bizLocation.id">
            <id property="id" column="bizLocation.id"/>
            <result property="receiver" column="bizLocation.receiver"/>
            <result property="phone" column="bizLocation.phone"/>
            <result property="address" column="bizLocation.address"/>
            <association property="province" javaType="SysRegion" column="province.id">
                <id property="id" column="province.id"/>
                <result property="name" column="province.name"/>
            </association>
            <association property="city" javaType="SysRegion" column="city.id">
                <id property="id" column="city.id"/>
                <result property="name" column="city.name"/>
            </association>
            <association property="region" javaType="SysRegion" column="region.id">
                <id property="id" column="region.id"/>
                <result property="name" column="region.name"/>
            </association>
        </association>

        <association property="platformInfo" javaType="BizPlatformInfo" column="platformInfo.id">
            <id property="id" column="platformInfo.id"/>
            <result property="name" column="platformInfo.name"/>
        </association>

        <association property="createBy" javaType="User" column="createBy.id">
            <id property="id" column="createBy.id"/>
        </association>
        <association property="updateBy" javaType="User" column="updateBy.id">
            <id property="id" column="updateBy.id"/>
        </association>

        <collection property="orderDetailList" ofType="BizOrderDetail">
            <id property="id" column="orderDetailList.id" />
			<result property="ordQty" column="orderDetailList.ordQty" />
            <association property="skuInfo" javaType="BizSkuInfo" column="skuInfo.id">
                <id property="id" column="orderDetailList.skuInfo.id"/>
                <result property="buyPrice" column="orderDetailList.skuInfo.buyPrice" />
                <result property="itemNo" column="orderDetailList.skuInfo.itemNo"/>
            </association>
        </collection>


    </resultMap>


	<sql id="bizOrderHeaderColumns">
		a.id AS "id",
		a.order_num AS "orderNum",
		a.order_type AS "orderType",
		a.cust_id AS "customer.id",
		so.name as "customer.name",
		so.phone AS "customer.phone",
		c.receiver as "bizLocation.receiver",
		c.phone as "bizLocation.phone",
		c.province_id as "bizLocation.province.id",
		province.name as "bizLocation.province.name",
		c.city_id as "bizLocation.city.id",
		city.name as "bizLocation.city.name",
		c.region_id as "bizLocation.region.id",
		reg.name as "bizLocation.region.name",
		c.address as "bizLocation.address",
		a.total_detail AS "totalDetail",
		a.receive_total as "receiveTotal",
		a.total_exp AS "totalExp",
		a.freight AS "freight",
		a.inv_status AS "invStatus",
		a.biz_status AS "bizStatus",
		a.biz_type as "bizType",
		a.plateform_id AS "platformInfo.id",
		bpi.name as "platformInfo.name",
		a.ship_to_addr AS "bizLocation.id",
		a.status AS "delFlag",
		a.create_id AS "createBy.id",
		su.name as "createBy.name",
		a.create_time AS "createDate",
		a.u_version AS "uVersion",
		a.update_id AS "updateBy.id",
		su.name as "updateBy.name",
		a.update_time AS "updateDate"
	</sql>

	<sql id="bizOrderHeaderJoins">
		left join sys_office as so on a.cust_id=so.id
		LEFT JOIN biz_order_address c ON c.id = a.ship_to_addr
        LEFT JOIN sys_region province ON c.province_id = province.id
        LEFT JOIN sys_region city ON c.city_id = city.id
        LEFT JOIN sys_region reg ON c.region_id = reg.id
		left join sys_user su on a.create_id=su.id
		left join biz_cms_platform_info bpi on a.plateform_id=bpi.id
    	LEFT JOIN biz_custom_center_consultant ccs ON ccs.cust_id=a.cust_id
		LEFT JOIN sys_office s on s.id=ccs.center_id
	</sql>

	<select id="get" resultType="BizOrderHeader">
		SELECT
			<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		WHERE a.id = #{id}
	</select>

	<!--<select id="findList" resultType="BizOrderHeader">-->
		<!--SELECT-->
			<!--<include refid="bizOrderHeaderColumns"/>-->
            <!--from biz_order_header a-->
		<!--<include refid="bizOrderHeaderJoins"/>-->
		<!--<where>-->
			<!--a.status = #{DEL_FLAG_NORMAL}-->
			<!--<if test="orderNum != null and orderNum != ''">-->
				<!--AND a.order_num-->
				<!--LIKE-->
				<!--<if test="dbName == 'oracle'">'%'||#{orderNum}||'%'</if>-->
				<!--<if test="dbName == 'mssql'">'%'+#{orderNum}+'%'</if>-->
				<!--<if test="dbName == 'mysql'">concat('%',#{orderNum},'%')</if>-->
			<!--</if>-->
			<!--<if test="orderType != null and orderType != ''">-->
				<!--AND a.order_type = #{orderType}-->
			<!--</if>-->
			<!--<if test="customer != null and customer.id != null and customer.id!=''">-->
				<!--AND a.cust_id = #{customer.id}-->
			<!--</if>-->
			<!--<if test="customer != null and customer.phone != null and customer.phone!=''">-->
				<!--AND su.mobile LIKE-->
				<!--<if test="dbName == 'oracle'">'%'||#{customer.phone}||'%'</if>-->
				<!--<if test="dbName == 'mssql'">'%'+#{customer.phone}+'%'</if>-->
				<!--<if test="dbName == 'mysql'">concat('%',#{customer.phone},'%')</if>-->
			<!--</if>-->
			<!--<if test="receiveTotal != null and receiveTotal != ''">-->
				<!--AND a.receive_total = #{receiveTotal}-->
			<!--</if>-->
			<!--<if test="bizStatus !=null">-->
				<!--AND a.biz_status=#{bizStatus}-->
			<!--</if>-->
			<!--<if test="bizType !=null and bizType!=''">-->
				<!--AND a.biz_type=#{bizType}-->
			<!--</if>-->
			<!--<if test="bizStatusStart !=null and bizStatusEnd !=null">-->
				<!--AND a.biz_status BETWEEN #{bizStatusStart} and #{bizStatusEnd}-->
			<!--</if>-->
			<!--<if test="invStatus !=null and invStatus!=''">-->
				<!--AND a.inv_status=#{invStatus}-->
			<!--</if>-->
			<!--<if test="consultantId!=null">-->
				<!--and ccs.consultant_id = #{consultantId}-->
			<!--</if>-->

			<!--<if test="centerId!=null">-->
				<!--and ccs.center_id = #{centerId}-->
			<!--</if>-->


			<!--<if test="sqlMap != null and sqlMap.order != null and sqlMap.order != ''">-->
				<!--${sqlMap.order}-->
			<!--</if>-->
		<!--</where>-->
		<!--<choose>-->
			<!--<when test="page !=null and page.orderBy != null and page.orderBy != ''">-->
				<!--ORDER BY ${page.orderBy}-->
			<!--</when>-->
			<!--<otherwise>-->
			<!--</otherwise>-->
		<!--</choose>-->
		<!--ORDER BY updateDate DESC-->
	<!--</select>-->


    <select id="findList" resultMap="orderHeaderResult">
        SELECT
        <include refid="bizOrderHeaderColumns"/>,
        od.id AS "orderDetailList.id",
		od.unit_price AS "orderDetailList.unitPrice",
		od.ord_qty AS "orderDetailList.ordQty",
        si.id AS "orderDetailList.skuInfo.id",
        si.buy_price AS "orderDetailList.skuInfo.buyPrice",
        si.item_no AS "orderDetailList.skuInfo.itemNo"
        FROM biz_order_header a
        LEFT JOIN biz_order_detail od ON od.order_id = a.id
        LEFT JOIN biz_sku_info si ON si.id=od.sku_id
        <include refid="bizOrderHeaderJoins"/>
        <where>
            a.status = #{DEL_FLAG_NORMAL}
            <if test="orderNum != null and orderNum != ''">
                AND a.order_num
                LIKE
                <if test="dbName == 'oracle'">'%'||#{orderNum}||'%'</if>
                <if test="dbName == 'mssql'">'%'+#{orderNum}+'%'</if>
                <if test="dbName == 'mysql'">concat('%',#{orderNum},'%')</if>
            </if>
            <if test="orderType != null and orderType != ''">
                AND a.order_type = #{orderType}
            </if>
            <if test="customer != null and customer.id != null and customer.id!=''">
                AND a.cust_id = #{customer.id}
            </if>
            <if test="customer != null and customer.phone != null and customer.phone!=''">
                AND su.mobile LIKE
                <if test="dbName == 'oracle'">'%'||#{customer.phone}||'%'</if>
                <if test="dbName == 'mssql'">'%'+#{customer.phone}+'%'</if>
                <if test="dbName == 'mysql'">concat('%',#{customer.phone},'%')</if>
            </if>
            <if test="receiveTotal != null and receiveTotal != ''">
                AND a.receive_total = #{receiveTotal}
            </if>
            <if test="bizStatus !=null">
                AND a.biz_status=#{bizStatus}
            </if>
            <if test="bizType !=null and bizType!=''">
                AND a.biz_type=#{bizType}
            </if>
            <if test="bizStatusStart !=null and bizStatusEnd !=null">
                AND a.biz_status BETWEEN #{bizStatusStart} and #{bizStatusEnd}
            </if>
            <if test="invStatus !=null and invStatus!=''">
                AND a.inv_status=#{invStatus}
            </if>
            <if test="consultantId!=null">
                and ccs.consultant_id = #{consultantId}
            </if>

            <if test="centerId!=null">
                and ccs.center_id = #{centerId}
            </if>

            <if test="itemNo !=null and itemNo !=''">
                and si.item_no
				LIKE
				<if test="dbName == 'oracle'">'%'||#{itemNo}||'%'</if>
				<if test="dbName == 'mssql'">'%'+#{itemNo}+'%'</if>
				<if test="dbName == 'mysql'">concat('%',#{itemNo},'%')</if>
            </if>

            <if test="sqlMap != null and sqlMap.order != null and sqlMap.order != ''">
                ${sqlMap.order}
            </if>
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
            </otherwise>
        </choose>
        ORDER BY updateDate DESC
    </select>
	<select id="findAllList" resultType="BizOrderHeader">
		SELECT 
			<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		<where>
			a.status = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
		ORDER BY updateDate DESC
	</select>
	
	<insert id="insert" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO biz_order_header(
			id,
			order_num,
			order_type,
			cust_id,
			total_detail,
		<if test="receiveTotal !=null and receiveTotal !=''">
			receive_total,
		</if>
			total_exp,
			freight,
		<if test="invStatus !=null and invStatus !=''">
			inv_status,
		</if>
		<if test="bizStatus !=null and bizStatus !=''">
			biz_status,
		</if>
			biz_type,
			plateform_id,
			ship_to_addr,
			status,
			create_id,
			create_time,
			u_version,
			update_id,
			update_time
		) VALUES (
			#{id},
			#{orderNum},
			#{orderType},
			#{customer.id},
			#{totalDetail},
		<if test="receiveTotal !=null and receiveTotal !=''">
			#{receiveTotal},
		</if>
			#{totalExp},
			#{freight},
		<if test="invStatus !=null and invStatus !=''">
			#{invStatus},
		</if>
		<if test="bizStatus !=null and bizStatus !=''">
			#{bizStatus},
		</if>
			#{bizType},
			#{platformInfo.id},
			#{bizLocation.id},
			#{delFlag},
			#{createBy.id},
			#{createDate},
			#{uVersion},
			#{updateBy.id},
			#{updateDate}
		)
	</insert>
	
	<update id="update">
		UPDATE biz_order_header SET
			order_num = #{orderNum},
			order_type = #{orderType},
			cust_id = #{customer.id},
			total_detail = #{totalDetail},
		<if test="receiveTotal !=null and receiveTotal !=''">
			receive_total = #{receiveTotal},
		</if>
			total_exp = #{totalExp},
			freight = #{freight},
			inv_status = #{invStatus},
			biz_status = #{bizStatus},
			biz_type = #{bizType},
			plateform_id = #{platformInfo.id},
			ship_to_addr = #{bizLocation.id},
			u_version = #{uVersion},
			update_id = #{updateBy.id},
			update_time = #{updateDate}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE biz_order_header SET 
			status = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="findListFirstOrder" resultType="BizOrderHeader">
		SELECT
		<include refid="bizOrderHeaderColumns"/>
		FROM biz_order_header a
		<include refid="bizOrderHeaderJoins"/>
		<where>
			a.status = #{DEL_FLAG_NORMAL}
			<if test="customer !=null and customer.id!=null and customer.id!=''">
				AND a.cust_id=#{customer.id}
			</if>
			<if test="bizStatus !=null">
				AND a.biz_status !=#{bizStatus}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>

	<update id="updateMoney">
		UPDATE biz_order_header SET
			total_detail = #{totalDetail}
		<if test="totalExp !=null and totalExp !=''">
			,total_exp = #{totalExp}
		</if>
		<if test="freight !=null and freight !=''">
			,freight = #{freight}
		</if>
		WHERE id = #{id}
	</update>
</mapper>